{% extends 'blog/base.html' %}

{% block content %}
    <article class="task">
        <aside class="actions">
            {% if user.is_authenticated %}
                <a class="btn btn-default" href="{% url 'task_edit' pk=task.pk %}">Modifier</a>
                <a class="btn btn-danger" href="{% url 'task_delete' pk=task.pk %}">Suprimer</a>

                <button id="toggle-btn"
                        data-task-id="{{ task.pk }}"
                        class="btn {% if task.status %}btn-success{% else %}btn-warning{% endif %}">
                    {% if task.status %}Marquer non fait{% else %} Marquer fait{% endif %}
                </button>

            {% endif %}
        </aside>
        <time class="date">
            {{ task.due_date }}
        </time>
        <h2>{{ task.title }}</h2>
        <p>{{ task.description|linebreaksbr }}</p>

        <p id="task-status">
            <strong>Statut :</strong> {% if task.status %}Fait{% else %}Non fait{% endif %}
        </p>

    </article>

    <script>

    document.body.onload = function () {

        var button = document.getElementById("toggle-btn");
        var statusParagraph = document.getElementById("task-status");

        button.onclick = function () {

            var taskId = button.getAttribute("data-task-id");

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/task/" + taskId + "/toggle-ajax/", true);

            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");

            xhr.onreadystatechange = function () {

                if (xhr.readyState === 4 && xhr.status === 200) {

                    var data = JSON.parse(xhr.responseText);

                    if (data.status) {
                        button.textContent = "Marquer non fait";

                    } else {
                        button.textContent = "Marquer fait";

                    }

                    statusParagraph.textContent = "";

                    var strong = document.createElement("strong");
                    strong.appendChild(document.createTextNode("Statut : "));
                    statusParagraph.appendChild(strong);

                    var text;

                    if (data.status) {

                        text = document.createTextNode("Fait");
                    } else {

                        text = document.createTextNode("Non fait");
                    }

                    statusParagraph.appendChild(text);
                }
            };

            xhr.send();
        };
    };

</script>



{% endblock %}